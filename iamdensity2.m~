function [] = iamdensity2(mldfile,dx,xMin,xMax,yMin,yMax,zMin,zMax)
%IAMDENSITY Reads .xyz file of molecule, loads spline functions
% of each atomic radial electron density. 
% Creates IAM molecular density on a 3D grid of size N^3.

[~,title0,~]=fileparts(mldfile);
title_=strcat(title0,'_elDensity_iam');

[~,~,~,~,~,~,~,~,~,~,~,~,~,Atoms] = mldread2(mldfile);
% Atoms=xyzread(xyzfile);
disp(Atoms)
% au2ang = 0.52917721092d0;
coords=Atoms(:,3:5);
ZZ=Atoms(:,2);
Nat=size(Atoms,1);

% keyboard

load c_6-31g_hf_elDensity
RhoC=Rho3D;
xC=xGrid; yC=yGrid; zC=zGrid;
load h_6-31g_hf_elDensity
RhoH=Rho3D;
xH=xGrid; yH=yGrid; zH=zGrid;
load o_6-31g_hf_elDensity
RhoO=Rho3D;
xO=xGrid; yO=yGrid; zO=zGrid;

% Create a grid
xGrid=xMin:dx:xMax;
yGrid=yMin:dx:yMax;
zGrid=zMin:dx:zMax;

[X,Y,Z] = meshgrid(xGrid,yGrid,zGrid);

Nx=length(xGrid);
Ny=length(yGrid);
Nz=length(zGrid);

Rho3D=zeros(Nx,Ny,Nz);
for a=1:Nat
    disp(100*a/Nat)
    if ZZ(a)==1
        xH_=xH+coords(a,1); yH_=yH+coords(a,2); zH_=zH+coords(a,3);  
        xH_=xH; yH_=yH; zH_=zH;
        Rho3D=Rho3D+interp3(xH_,yH_,zH_,RhoH,X,Y,Z);
        Rho3D(isnan(Rho3D))=0;
    elseif ZZ(a)==6
        xC_=xC+coords(a,1); yC_=yC+coords(a,2); zC_=zC+coords(a,3);  
        xC_=xC; yC_=yC; zC_=zC;
        Rho3D=Rho3D+interp3(xC_,yC_,zC_,RhoC,X,Y,Z);
        Rho3D(isnan(Rho3D))=0;
    elseif ZZ(a)==8
        xO_=xO+coords(a,1); yO_=yO+coords(a,2); zO_=zO+coords(a,3);
        xO_=xO+coords(a,1); yO_=yO+coords(a,2); zO_=zO+coords(a,3);
        Rho3D=Rho3D+interp3(xO_,yO_,zO_,RhoO,X,Y,Z); 
        Rho3D(isnan(Rho3D))=0;
    end
end

save(['results/',title_],'Rho3D','xGrid','yGrid','zGrid','Atoms')

% Total numer of electrons; dx^3 is the volume element
dx=abs(xGrid(2)-xGrid(1));
totRho=sum(sum(sum(Rho3D)))*dx^3;
disp('Integrated number of electrons: ');
disp(num2str(totRho));
disp('True number of electrons: ');
disp(num2str(sum(Atoms(:,2))));

% plot
contourf(zGrid,yGrid,squeeze(Rho3D(ceil(Nz/2),:,:)),100,'edgecolor','none');
colorbar;
xlabel('$y (a_0)$','interpreter','latex');
ylabel('$x (a_0)$','interpreter','latex');
axis equal
axis tight

keyboard

end
